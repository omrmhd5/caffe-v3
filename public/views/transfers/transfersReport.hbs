{{> header}}
{{> navbar/navbar}}

<style>
  .table td {
    height: 75% !important;
    padding: .2rem !important;
    text-align: center;
  }

  .table th {
    padding: .3rem !important;
    text-align: center;
  }

  input {
    text-align: center;
  }

  .tax-title {
    font-weight: bold;
    color: black;
  }

   /* Approved dropdown styling */
   .approved-select {
     text-align: center;
   }

   .approved-select option[value="true"] {
     background-color: #28a745;
     color: white;
   }

   .approved-select option[value="false"] {
     background-color: #dc3545;
     color: white;
   }

   .approved-select.approved-yes {
     background-color: #28a745 !important;
     color: white !important;
   }

   .approved-select.approved-no {
     background-color: #dc3545 !important;
     color: white !important;
   }

  /* Sticky table headers */
  .table-responsive {
    overflow-x: auto;
  }

  #transfers-table {
    position: relative;
  }

  #transfers-table thead {
    position: sticky;
    top: 0;
    z-index: 10;
    background: white;
  }

  #transfers-table thead th {
    background: white;
    border-bottom: 2px solid #dee2e6;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  /* Ensure the sticky header works properly */
  #transfers-table tbody tr:first-child td {
    border-top: none;
  }

  /* Highlight effect for the last edited row */
  .highlight-row {
    background-color: #fff3cd !important;
    border: 2px solid #ffc107 !important;
    transition: all 0.3s ease;
  }

  .highlight-row td {
    background-color: #fff3cd !important;
  }

  /* Print styles */
  @media print {
    .d-print-none {
      display: none !important;
    }
    
    .d-print-block {
      display: block !important;
    }
    
    /* Show all rows in print, regardless of filter */
    .transfer-tr {
      display: table-row !important;
    }
    
    /* Hide buttons and filters */
    #add-row-button,
    #show-all-button,
    #hide-approved-button,
    #save-button,
    .card-header,
    .card-footer {
      display: none !important;
    }
    
    /* Ensure table is visible */
    .table-responsive {
      overflow: visible !important;
    }
    
    body {
      background: white !important;
    }
  }

</style>

<div class=" bg-white col-md-12 d-print-none p-0" dir="rtl" style="padding: 0px 28px;" data-user-role="{{expreq.user.role}}">
  <div class="headerPage">
    <div class="Title">
      <h2 style="text-align: center;">
        ادارة التحويلات
      </h2>
    </div>
  </div>
  <div class="card d-print-none">
    <div class="card-header ">
      <form class="form-horizontal" action="/transfers" id="search-form" method="GET">
        <div class="form-group row">
          <label for="branchID" class="col-form-label pt-0">
            <p class="select">الفرع</p>
          </label>
          <div class="col-sm-2">
            {{#if branchedRole}}
            <select id="branchID" name="branchID" class="form-control" disabled>
              <option value="{{branch._id}}" selected> {{branch.branchname}} </option>
            </select>
            {{else}}
            <select id="branchID" name="branchID" class="form-control" onchange="submitSearchForm()" required>
              <option value="" selected disabled hidden> اختر الفرع </option>
              {{#each branches}}
              <option value="{{_id}}" {{selected}}>{{branchname}}</option>
              {{/each}}
            </select>
            {{/if}}
          </div>
          <label for="query-date" class="col-form-label pt-0">
            <p class="select mr-3">الشهر</p>
          </label>
          <div class="col-sm-2">
            <div class="input-group">
              <input id="query-date" type="month" onchange="submitSearchForm()" name="date" min="2019-01"
                class="form-control" value="{{date}}" required>
            </div>
          </div>
          <div class="col-sm-1">
            <button class="btnclass width6rem p-0"> بحث </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-body" style="padding-right: 0; padding-left: 0;">
      <div class="d-print-none mb-2" style="padding: 10px; text-align: right;">
        <button class="btn btn-primary btn-lg" id="add-row-button" style="margin-left: 10px;">
          <i class="fa fa-plus"></i> إضافة سجل جديد
        </button>
        <button class="btn btn-info btn-lg" id="show-all-button">
          <i class="fa fa-eye"></i> عرض الكل
        </button>
        <button class="btn btn-secondary btn-lg" id="hide-approved-button">
          <i class="fa fa-eye-slash"></i> إخفاء الموافق عليها
        </button>
      </div>
      <div class="table-responsive">
        <table id="transfers-table" class="table d-print-none">
          <thead style="height: 5px;">
            <tr>
              <th>
                <p class="tableheader width8rem mb-0"> الفرع </p>
              </th>
              <th>
                <p class="tableheader width8rem mb-0"> الشركة </p>
              </th>
              <th>
                <p class="tableheader width8rem mb-0"> الحجز المعني </p>
              </th>
              <th style="min-width: 10rem;">
                <p class="tableheader width8rem mb-0"> تاريخ الحجز </p>
              </th>
              <th>
                <p class="tableheader width8rem mb-0"> مبلغ الحجز </p>
              </th>
              <th>
                <p class="tableheader width8rem mb-0"> المبلغ المرسل في الموقع </p>
              </th>
              <th>
                <p class="tableheader width8rem mb-0"> المبلغ المحول في القروب </p>
              </th>
              <th>
                <p class="tableheader width8rem mb-0"> العمولة سند صرف </p>
              </th>
              <th>
                <p class="tableheader width8rem mb-0"> رسوم البنك </p>
              </th>
              <th>
                <p class="tableheader width8rem mb-0"> رقم السند </p>
              </th>
              <th>
                <p class="tableheader width8rem mb-0"> تم الاستلام </p>
              </th>
              <th>
                <p class="tableheader width8rem mb-0"> ملاحظات </p>
              </th>
            </tr>
          </thead>
          <tbody>
            {{#if data}}
              {{#each data}}
              <tr class="transfer-tr" data-approved="{{approved}}" {{#if createdAt}}data-created-at="{{createdAt}}"{{/if}}>
                <td><input type="hidden" class="transfer-id" value="{{_id}}"><input class="form-control branch-name" value="{{branchName}}" disabled></td>
                <td>
                  <select class="form-control company-name">
                    <option value="">اختر الشركة</option>
                    <option value="اقودا" {{#ifEquals companyName "اقودا"}}selected{{/ifEquals}}>اقودا</option>
                    <option value="اكسبيديا" {{#ifEquals companyName "اكسبيديا"}}selected{{/ifEquals}}>اكسبيديا</option>
                    <option value="TRIP" {{#ifEquals companyName "TRIP"}}selected{{/ifEquals}}>TRIP</option>
                    <option value="بوكينق" {{#ifEquals companyName "بوكينق"}}selected{{/ifEquals}}>بوكينق</option>
                    <option value="اخرى" {{#ifEquals companyName "اخرى"}}selected{{/ifEquals}}>اخرى</option>
                    <option value="المطار" {{#ifEquals companyName "المطار"}}selected{{/ifEquals}}>المطار</option>
                    <option value="المسافر" {{#ifEquals companyName "المسافر"}}selected{{/ifEquals}}>المسافر</option>
                    <option value="اخرى 1" {{#ifEquals companyName "اخرى 1"}}selected{{/ifEquals}}>اخرى 1</option>
                    <option value="اخرى 2" {{#ifEquals companyName "اخرى 2"}}selected{{/ifEquals}}>اخرى 2</option>
                  </select>
                </td>
                <td><input class="form-control reservation-ref" value="{{reservationRef}}"></td>
                <td><input type="text" class="form-control reservation-date" value="{{reservationDate}}" disabled></td>
                <td><input type="number" class="form-control reservation-amount" value="{{toFixed reservationAmount}}"></td>
                <td><input type="number" class="form-control sent-amount" value="{{toFixed sentAmount}}"></td>
                <td><input type="number" class="form-control transferred-amount" value="{{toFixed transferredAmount}}"></td>
                <td><input type="number" class="form-control commission-voucher" value="{{toFixed commissionVoucher}}" disabled></td>
                <td><input type="number" class="form-control bank-fees" value="{{toFixed bankFees}}" disabled></td>
                <td><input class="form-control voucher-number" value="{{voucherNumber}}"></td>
                <td>
                  <select class="form-control approved-select" {{#ifNotEquals expreq.user.role "AccountantManager"}}disabled{{/ifNotEquals}}>
                    <option value="false" {{#unless approved}}selected{{/unless}}>لا</option>
                    <option value="true" {{#if approved}}selected{{/if}}>نعم</option>
                  </select>
                </td>
                <td><input class="form-control notes" value="{{notes}}"></td>
              </tr>
              {{/each}}
            {{else}}
              <tr>
                <td colspan="12" style="text-align: center; padding: 20px;">
                  <p>لا توجد بيانات</p>
                </td>
              </tr>
            {{/if}}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Summary Field Row - Above buttons -->
  <div class="row d-flex justify-content-center mt-3">
    <!-- اجمالي التحويلات المعتمدة -->
    <div class="w-100 d-flex flex-column align-items-center justify-content-center my-2" style="max-width:200px;">
      <label class="form-control tax-title text-center" style="max-width:200px;margin-bottom:8px;">اجمالي التحويلات المعتمدة</label>
      <input class="form-control text-center" id="total-approved-amount" value="0.00" disabled style="font-weight:bold;max-width:160px;">
    </div>
  </div>

  <div class="card-footer d-print-block mt-3">
    <div class="totaldiv" style="width: 100%;">
      <div class="row d-flex justify-content-center">
        <div class="col-md-6 text-center">
          <button class="btn btn-lg mb-2 btnclass" id="save-button"> حفظ </button>
        </div>
        <div class="col-md-6 text-center">
          <button class="btnclass" id="print-button">اطبع</button>
        </div>
      </div>
    </div>
  </div>
</div>

{{> print/transfers branch=branch data=data date=date}}
{{> footer}}

<script>
  function submitSearchForm() {
    if ($('#branchID').val()) {
      $('#search-form').submit();
    }
  }

  // Add new row functionality
  $('#add-row-button').on('click', function() {
    // Check if branch is selected
    const branchSelect = $('#branchID');
    const selectedBranchID = branchSelect.val();
    
    if (!selectedBranchID) {
      swal('تنبيه', 'الرجاء اختيار الفرع أولاً', {
        icon: 'warning',
        buttons: {
          confirm: {
            className: 'btn btn-warning',
          },
        },
      });
      return;
    }
    
    const tbody = $('#transfers-table tbody');
    
    // Remove the "no data" row if it exists
    tbody.find('tr:has(td[colspan])').remove();
    
    // Get the selected branch name from the dropdown
    const selectedBranchText = branchSelect.find('option:selected').text().trim();
    
    // Create new row with empty inputs
    const newRow = `
      <tr class="transfer-tr" data-approved="false">
        <td><input type="hidden" class="transfer-id" value=""><input class="form-control branch-name" value="${selectedBranchText}" disabled></td>
        <td>
          <select class="form-control company-name">
            <option value="">اختر الشركة</option>
            <option value="اقودا">اقودا</option>
            <option value="اكسبيديا">اكسبيديا</option>
            <option value="TRIP">TRIP</option>
            <option value="بوكينق">بوكينق</option>
            <option value="اخرى">اخرى</option>
            <option value="المطار">المطار</option>
            <option value="المسافر">المسافر</option>
            <option value="اخرى 1">اخرى 1</option>
            <option value="اخرى 2">اخرى 2</option>
          </select>
        </td>
        <td><input class="form-control reservation-ref" value=""></td>
        <td><input type="text" class="form-control reservation-date" value="" disabled></td>
        <td><input type="number" class="form-control reservation-amount" value=""></td>
        <td><input type="number" class="form-control sent-amount" value=""></td>
        <td><input type="number" class="form-control transferred-amount" value=""></td>
        <td><input type="number" class="form-control commission-voucher" value="" disabled></td>
        <td><input type="number" class="form-control bank-fees" value="" disabled></td>
        <td><input class="form-control voucher-number" value=""></td>
         <td>
           <select class="form-control approved-select" disabled>
             <option value="false" selected>لا</option>
             <option value="true">نعم</option>
           </select>
         </td>
        <td><input class="form-control notes" value=""></td>
      </tr>
    `;
    
    tbody.append(newRow);
    
     // Enable approved dropdown only for AccountantManager
     const userRole = $('[data-user-role]').attr('data-user-role');
     const newRowApproved = tbody.find('tr:last .approved-select');
     if (userRole === 'AccountantManager') {
       newRowApproved.prop('disabled', false);
     }
     
     // Update approved dropdowns styling
     updateApprovedDropdowns();
    
    // Don't update data-approved attribute or apply filtering for new rows
    // Filtering will only apply after save and refresh
    const newRowElement = tbody.find('tr:last');
    newRowElement.find('.approved-select').on('change', function() {
      // Don't hide/show or update data-approved - let it be set from server after save
    });
    
    // Calculate initial values for the new row (will be calculated automatically when values are entered)
  });

   // Function to update approved dropdown styling and enabled/disabled state
   function updateApprovedDropdowns() {
     const userRole = $('[data-user-role]').attr('data-user-role');
     
     $('.approved-select').each(function() {
       // Enable/disable based on user role
       if (userRole === 'AccountantManager') {
         $(this).prop('disabled', false);
       } else {
         $(this).prop('disabled', true);
       }
       
       // Set initial colors
       $(this).removeClass('approved-yes approved-no');
       if ($(this).val() === 'true') {
         $(this).addClass('approved-yes');
       } else {
         $(this).addClass('approved-no');
       }
     });
     
     // Add change event listener to update background color
     $('.approved-select').off('change').on('change', function() {
       $(this).removeClass('approved-yes approved-no');
       if ($(this).val() === 'true') {
         $(this).addClass('approved-yes');
       } else {
         $(this).addClass('approved-no');
       }
     });
   }

   // Initialize on page load
   $(document).ready(function() {
     // The date input should already be set from the server template
     // If for some reason it's not set, set it to today's month
     const dateInput = $('#query-date');
     if (!dateInput.val() || dateInput.val().trim() === '') {
       const today = new Date();
       const year = today.getFullYear();
       const month = String(today.getMonth() + 1).padStart(2, '0');
       dateInput.val(`${year}-${month}`);
     }
     
     updateApprovedDropdowns();
     initializeAutoDateFill();
     initializeAutoCalculations();
     initializeFiltering();
     initializeTimeBasedDisabling();
     calculateTotalApproved();
   });

  // Function to calculate and display total approved transfers
  function calculateTotalApproved() {
    let total = 0;
    
    $('.transfer-tr').each(function() {
      const row = $(this);
      // Check if approved - use the select value if available, otherwise use data-approved attribute
      const approvedSelect = row.find('.approved-select');
      let isApproved = false;
      
      if (approvedSelect.length > 0) {
        // Use the current select value (for unsaved changes)
        isApproved = approvedSelect.val() === 'true';
      } else {
        // Fall back to data-approved attribute (for saved records)
        isApproved = row.attr('data-approved') === 'true';
      }
      
      if (isApproved) {
        const reservationAmountInput = row.find('.reservation-amount');
        if (reservationAmountInput.length > 0) {
          const amount = parseFloat(reservationAmountInput.val()) || 0;
          total += amount;
        }
      }
    });
    
    // Update the display with formatted number (2 decimal places)
    $('#total-approved-amount').val(total.toFixed(2));
  }

  // Function to disable fields based on creation time (4 hours rule)
  function initializeTimeBasedDisabling() {
    const userRole = $('[data-user-role]').attr('data-user-role');
    
    // AccountantManager can always edit, skip this logic
    if (userRole === 'AccountantManager') {
      return;
    }
    
    // 4 hours in seconds (4 * 60 * 60 = 14400)
    const FOUR_HOURS_IN_SECONDS = 14400;
    
    // Check each row and disable if 4 hours have passed
    function checkAndDisableRow(row) {
      const createdAt = row.attr('data-created-at');
      
      // If no createdAt (new row), keep it enabled
      if (!createdAt) {
        return;
      }
      
      const createdTime = new Date(createdAt).getTime();
      const currentTime = new Date().getTime();
      const secondsPassed = (currentTime - createdTime) / 1000;
      
      // If 4 hours or more have passed, disable all inputs
      if (secondsPassed >= FOUR_HOURS_IN_SECONDS) {
        row.find('input:not(.branch-name):not(.reservation-date):not(.commission-voucher):not(.bank-fees)').prop('disabled', true);
        row.find('select:not(.approved-select)').prop('disabled', true);
        // Keep approved-select disabled for non-managers anyway
        row.find('.approved-select').prop('disabled', true);
      }
    }
    
    // Check all existing rows on page load
    $('.transfer-tr').each(function() {
      checkAndDisableRow($(this));
    });
    
    // Set up interval to check every minute for rows that might cross the 4-hour threshold
    setInterval(function() {
      $('.transfer-tr').each(function() {
        const row = $(this);
        const createdAt = row.attr('data-created-at');
        
        if (!createdAt) {
          return; // New row, skip
        }
        
        const createdTime = new Date(createdAt).getTime();
        const currentTime = new Date().getTime();
        const secondsPassed = (currentTime - createdTime) / 1000;
        
        // If 4 hours have passed (or more), disable
        if (secondsPassed >= FOUR_HOURS_IN_SECONDS) {
          // Check if already disabled to avoid repeated operations
          const firstInput = row.find('input:not(.branch-name):not(.reservation-date):not(.commission-voucher):not(.bank-fees)').first();
          if (!firstInput.prop('disabled')) {
            row.find('input:not(.branch-name):not(.reservation-date):not(.commission-voucher):not(.bank-fees)').prop('disabled', true);
            row.find('select:not(.approved-select)').prop('disabled', true);
            row.find('.approved-select').prop('disabled', true);
          }
        }
      });
    }, 60000); // Check every minute (60000 ms)
  }

  // Function to filter rows based on approved status
  function filterRows(showAll) {
    $('.transfer-tr').each(function() {
      const row = $(this);
      const isApproved = row.attr('data-approved') === 'true';
      
      if (showAll) {
        row.show();
      } else {
        // Hide approved records
        if (isApproved) {
          row.hide();
        } else {
          row.show();
        }
      }
    });
  }

  // Initialize filtering - hide approved by default
  function initializeFiltering() {
    // Hide approved records by default
    filterRows(false);
    
    // Mark "Hide Approved" button as active by default
    $('#hide-approved-button').addClass('active');
    
    // Update data-approved attribute when dropdown changes
    // But don't apply filtering until save and refresh
    $(document).on('change', '.approved-select', function() {
      const row = $(this).closest('tr');
      const isApproved = $(this).val() === 'true';
      // Don't update data-approved attribute here - let it be set from server after save
      // This way, filtering only applies to saved records, not unsaved changes
      // Update total when approved status changes
      calculateTotalApproved();
    });
    
    // Update total when reservation amount changes
    $(document).on('input change', '.reservation-amount', function() {
      calculateTotalApproved();
    });
  }

  // Show all button
  $('#show-all-button').on('click', function() {
    filterRows(true);
    $(this).addClass('active');
    $('#hide-approved-button').removeClass('active');
  });

  // Hide approved button
  $('#hide-approved-button').on('click', function() {
    filterRows(false);
    $(this).addClass('active');
    $('#show-all-button').removeClass('active');
  });

  // Function to auto-calculate commission voucher and bank fees
  function initializeAutoCalculations() {
    // Function to calculate values for a specific row
    function calculateRowValues(row) {
      const reservationAmount = parseFloat(row.find('.reservation-amount').val()) || 0;
      const sentAmount = parseFloat(row.find('.sent-amount').val()) || 0;
      const transferredAmount = parseFloat(row.find('.transferred-amount').val()) || 0;
      
      // العمولة سند صرف = مبلغ الحجز - المبلغ المحول في القروب
      const commissionVoucher = reservationAmount - transferredAmount;
      row.find('.commission-voucher').val(commissionVoucher.toFixed(2));
      
      // رسوم البنك = المبلغ المرسل في الموقع - المبلغ المحول في القروب
      const bankFees = sentAmount - transferredAmount;
      row.find('.bank-fees').val(bankFees.toFixed(2));
    }
    
    // Handle changes to reservation amount, sent amount, or transferred amount
    $(document).on('input change', '.reservation-amount, .sent-amount, .transferred-amount', function() {
      const row = $(this).closest('tr');
      calculateRowValues(row);
    });
    
    // Calculate initial values for existing rows
    $('.transfer-tr').each(function() {
      calculateRowValues($(this));
    });
  }

  // Function to auto-fill reservation date when both company and reservation ref are present
  function initializeAutoDateFill() {
    // Function to check and fill date for a specific row
    function checkAndFillDate(row) {
      const companySelect = row.find('.company-name');
      const reservationRef = row.find('.reservation-ref');
      const reservationDate = row.find('.reservation-date');
      
      // Only fill date if it's empty (not already set from a previous save)
      const currentDateValue = reservationDate.val();
      if (currentDateValue && currentDateValue.trim() !== '') {
        return; // Date already set, don't update it
      }
      
      const companyValue = companySelect.val();
      const refValue = reservationRef.val().trim();
      
      // Only fill if both are present and date is empty
      if (companyValue && refValue) {
        // Get today's date and current time in HH:mm:ss mm/dd/yyyy format (time before date)
        const today = new Date();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const year = today.getFullYear();
        const hours = String(today.getHours()).padStart(2, '0');
        const minutes = String(today.getMinutes()).padStart(2, '0');
        const seconds = String(today.getSeconds()).padStart(2, '0');
        const formattedDate = `${hours}:${minutes}:${seconds} ${month}/${day}/${year}`;
        
        reservationDate.val(formattedDate);
      }
    }
    
    // Handle company dropdown change
    $(document).on('change', '.company-name', function() {
      const row = $(this).closest('tr');
      checkAndFillDate(row);
    });
    
    // Handle reservation ref input blur (when user leaves the field)
    $(document).on('blur', '.reservation-ref', function() {
      const row = $(this).closest('tr');
      checkAndFillDate(row);
    });
    
    // Handle reservation ref input enter key
    $(document).on('keypress', '.reservation-ref', function(e) {
      if (e.which === 13) { // Enter key
        e.preventDefault();
        const row = $(this).closest('tr');
        checkAndFillDate(row);
        $(this).blur(); // Remove focus
      }
    });
  }

  // Save button functionality
  $('#save-button').on('click', function() {
    const branchID = $('#branchID').val();
    
    if (!branchID) {
      swal('تنبيه', 'الرجاء اختيار الفرع', {
        icon: 'warning',
        buttons: {
          confirm: {
            className: 'btn btn-warning',
          },
        },
      });
      return;
    }

    const transfers = [];
    
    // Recalculate all values before saving to ensure they're up to date
    $('.transfer-tr').each(function() {
      const row = $(this);
      if (row.find('td[colspan]').length === 0) {
        // Recalculate commission and bank fees for this row
        const reservationAmount = parseFloat(row.find('.reservation-amount').val()) || 0;
        const sentAmount = parseFloat(row.find('.sent-amount').val()) || 0;
        const transferredAmount = parseFloat(row.find('.transferred-amount').val()) || 0;
        const commissionVoucher = reservationAmount - transferredAmount;
        const bankFees = sentAmount - transferredAmount;
        row.find('.commission-voucher').val(commissionVoucher.toFixed(2));
        row.find('.bank-fees').val(bankFees.toFixed(2));
      }
    });
    
    // Collect data from all rows (skip header and "no data" row)
    $('.transfer-tr').each(function() {
      const row = $(this);
      
      // Skip if it's the "no data" row
      if (row.find('td[colspan]').length > 0) {
        return;
      }

      const companyName = row.find('.company-name').val();
      const reservationRef = row.find('.reservation-ref').val();
      
      // Only add if at least company or reservation ref is filled
      if (companyName || reservationRef) {
        const transferId = row.find('.transfer-id').val();
        const transferData = {
          _id: transferId && transferId.trim() !== '' ? transferId : null, // Include _id if it exists (for updates)
          companyName: companyName || '',
          reservationRef: reservationRef || '',
          reservationDate: row.find('.reservation-date').val() || '',
          reservationAmount: parseFloat(row.find('.reservation-amount').val()) || 0,
          sentAmount: parseFloat(row.find('.sent-amount').val()) || 0,
          transferredAmount: parseFloat(row.find('.transferred-amount').val()) || 0,
          commissionVoucher: parseFloat(row.find('.commission-voucher').val()) || 0,
          bankFees: parseFloat(row.find('.bank-fees').val()) || 0,
          voucherNumber: row.find('.voucher-number').val() || '',
          approved: row.find('.approved-select').val() === 'true',
          notes: row.find('.notes').val() || '',
        };
        
        transfers.push(transferData);
      }
    });

    if (transfers.length === 0) {
      swal('تنبيه', 'لا توجد بيانات للحفظ', {
        icon: 'warning',
        buttons: {
          confirm: {
            className: 'btn btn-warning',
          },
        },
      });
      return;
    }

    // Send data to backend
    const url = '/transfers';
    const method = 'POST';
    
    callUrl(url, method, {
      transfers: JSON.stringify(transfers),
      branchID: branchID
    });
  });

  // callUrl function for AJAX requests
  function callUrl(url, method, data) {
    $.ajax({
      url,
      type: method,
      data: data,
      success: (data, status, xhr) => {
        swal({
          title: data.message,
          type: 'success',
          buttons: {
            confirm: {
              className: 'btn btn-success',
            },
          },
        }).then((OK) => {
          if (OK) {
            $(window).scrollTop(0);
            location.reload();
          }
        });
      },
      error: (jqXhr, textStatus, errorMessage) => {
        swal('حدث خطأ', jqXhr.responseJSON?.errorMessage || 'حدث خطأ أثناء الحفظ', {
          icon: 'error',
          buttons: {
            confirm: {
              className: 'btn btn-danger',
            },
          },
        }).then((OK) => {
          if (OK) {
            swal.close();
          }
        });
      },
    });
  }

  // Print button functionality
  $('#print-button').on('click', function() {
    window.print();
  });
</script>

