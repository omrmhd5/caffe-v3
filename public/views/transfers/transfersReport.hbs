{{> header}}
{{> navbar/navbar}}

<style>
  .table td {
    height: 75% !important;
    padding: .2rem !important;
    text-align: center;
  }

  .table th {
    padding: .3rem !important;
    text-align: center;
  }

  input {
    text-align: center;
  }

  /* Received dropdown styling */
  .received-select {
    text-align: center;
  }

  .received-select option[value="نعم"] {
    background-color: #28a745;
    color: white;
  }

  .received-select option[value="لا"] {
    background-color: #dc3545;
    color: white;
  }

  .received-select.received-yes {
    background-color: #28a745 !important;
    color: white !important;
  }

  .received-select.received-no {
    background-color: #dc3545 !important;
    color: white !important;
  }

  /* Sticky table headers */
  .table-responsive {
    overflow-x: auto;
  }

  #transfers-table {
    position: relative;
  }

  #transfers-table thead {
    position: sticky;
    top: 0;
    z-index: 10;
    background: white;
  }

  #transfers-table thead th {
    background: white;
    border-bottom: 2px solid #dee2e6;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  /* Ensure the sticky header works properly */
  #transfers-table tbody tr:first-child td {
    border-top: none;
  }

  /* Highlight effect for the last edited row */
  .highlight-row {
    background-color: #fff3cd !important;
    border: 2px solid #ffc107 !important;
    transition: all 0.3s ease;
  }

  .highlight-row td {
    background-color: #fff3cd !important;
  }

</style>

<div class=" bg-white col-md-12 d-print-none p-0" dir="rtl" style="padding: 0px 28px;" data-user-role="{{expreq.user.role}}">
  <div class="headerPage">
    <div class="Title">
      <h2 style="text-align: center;">
        ادارة التحويلات
      </h2>
    </div>
  </div>
  <div class="card d-print-none">
    <div class="card-header ">
      <form class="form-horizontal" action="/transfers" id="search-form" method="GET">
        <div class="form-group row">
          <label for="branchID" class="col-form-label pt-0">
            <p class="select">الفرع</p>
          </label>
          <div class="col-sm-2">
            {{#if branchedRole}}
            <select id="branchID" name="branchID" class="form-control" disabled>
              <option value="{{branch._id}}" selected> {{branch.branchname}} </option>
            </select>
            {{else}}
            <select id="branchID" name="branchID" class="form-control" onchange="submitSearchForm()" required>
              <option value="" selected disabled hidden> اختر الفرع </option>
              {{#each branches}}
              <option value="{{_id}}" {{selected}}>{{branchname}}</option>
              {{/each}}
            </select>
            {{/if}}
          </div>
          <div class="col-sm-1">
            <button class="btnclass width6rem p-0"> بحث </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-body" style="padding-right: 0; padding-left: 0;">
      <div class="d-print-none mb-2" style="padding: 10px;">
        <button class="btn btn-primary btn-lg" id="add-row-button">
          <i class="fa fa-plus"></i> إضافة سجل جديد
        </button>
      </div>
      <div class="table-responsive">
        <table id="transfers-table" class="table d-print-none">
          <thead style="height: 5px;">
            <tr>
              <th>
                <p class="tableheader width8rem mb-0"> الفرع </p>
              </th>
              <th>
                <p class="tableheader width8rem mb-0"> الشركة </p>
              </th>
              <th>
                <p class="tableheader width8rem mb-0"> الحجز المعني </p>
              </th>
              <th style="min-width: 10rem;">
                <p class="tableheader width8rem mb-0"> تاريخ الحجز </p>
              </th>
              <th>
                <p class="tableheader width8rem mb-0"> مبلغ الحجز </p>
              </th>
              <th>
                <p class="tableheader width8rem mb-0"> المبلغ المرسل في الموقع </p>
              </th>
              <th>
                <p class="tableheader width8rem mb-0"> المبلغ المحول في القروب </p>
              </th>
              <th>
                <p class="tableheader width8rem mb-0"> العمولة سند صرف </p>
              </th>
              <th>
                <p class="tableheader width8rem mb-0"> رسوم البنك </p>
              </th>
              <th>
                <p class="tableheader width8rem mb-0"> رقم السند </p>
              </th>
              <th>
                <p class="tableheader width8rem mb-0"> تم الاستلام </p>
              </th>
              <th>
                <p class="tableheader width8rem mb-0"> ملاحظات </p>
              </th>
            </tr>
          </thead>
          <tbody>
            {{#if data}}
              {{#each data}}
              <tr class="transfer-tr">
                <td><input class="form-control branch-name" value="{{branchName}}" disabled></td>
                <td>
                  <select class="form-control company-name">
                    <option value="">اختر الشركة</option>
                    <option value="اقودا" {{#ifEquals companyName "اقودا"}}selected{{/ifEquals}}>اقودا</option>
                    <option value="اكسبيديا" {{#ifEquals companyName "اكسبيديا"}}selected{{/ifEquals}}>اكسبيديا</option>
                    <option value="TRIP" {{#ifEquals companyName "TRIP"}}selected{{/ifEquals}}>TRIP</option>
                    <option value="بوكينق" {{#ifEquals companyName "بوكينق"}}selected{{/ifEquals}}>بوكينق</option>
                    <option value="اخرى" {{#ifEquals companyName "اخرى"}}selected{{/ifEquals}}>اخرى</option>
                    <option value="المطار" {{#ifEquals companyName "المطار"}}selected{{/ifEquals}}>المطار</option>
                    <option value="المسافر" {{#ifEquals companyName "المسافر"}}selected{{/ifEquals}}>المسافر</option>
                    <option value="اخرى 1" {{#ifEquals companyName "اخرى 1"}}selected{{/ifEquals}}>اخرى 1</option>
                    <option value="اخرى 2" {{#ifEquals companyName "اخرى 2"}}selected{{/ifEquals}}>اخرى 2</option>
                  </select>
                </td>
                <td><input class="form-control reservation-ref" value="{{reservationRef}}"></td>
                <td><input type="text" class="form-control reservation-date" value="{{formatDate reservationDate}}" disabled></td>
                <td><input type="number" class="form-control reservation-amount" value="{{toFixed reservationAmount}}"></td>
                <td><input type="number" class="form-control sent-amount" value="{{toFixed sentAmount}}"></td>
                <td><input type="number" class="form-control transferred-amount" value="{{toFixed transferredAmount}}"></td>
                <td><input type="number" class="form-control commission-voucher" value="{{toFixed commissionVoucher}}" disabled></td>
                <td><input type="number" class="form-control bank-fees" value="{{toFixed bankFees}}" disabled></td>
                <td><input class="form-control voucher-number" value="{{voucherNumber}}"></td>
                <td>
                  <select class="form-control received-select" {{#ifNotEquals expreq.user.role "AccountantManager"}}disabled{{/ifNotEquals}}>
                    <option value="لا" {{#ifEquals received "لا"}}selected{{/ifEquals}} {{#unless received}}selected{{/unless}}>لا</option>
                    <option value="نعم" {{#ifEquals received "نعم"}}selected{{/ifEquals}}>نعم</option>
                  </select>
                </td>
                <td><input class="form-control notes" value="{{notes}}"></td>
              </tr>
              {{/each}}
            {{else}}
              <tr>
                <td colspan="12" style="text-align: center; padding: 20px;">
                  <p>لا توجد بيانات</p>
                </td>
              </tr>
            {{/if}}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card-footer d-print-block mt-3">
    <div class="totaldiv" style="width: 100%;">
      <div class="row d-flex justify-content-center">
        <div class="col-md-6 text-center">
          <button class="btn btn-lg mb-2 btnclass" id="save-button"> حفظ </button>
        </div>
        <div class="col-md-6 text-center">
          <button class="btnclass" id="print-button">اطبع</button>
        </div>
      </div>
    </div>
  </div>
</div>

{{> footer}}

<script>
  function submitSearchForm() {
    if ($('#branchID').val()) {
      $('#search-form').submit();
    }
  }

  // Add new row functionality
  $('#add-row-button').on('click', function() {
    const tbody = $('#transfers-table tbody');
    
    // Remove the "no data" row if it exists
    tbody.find('tr:has(td[colspan])').remove();
    
    // Get the selected branch name from the dropdown
    const branchSelect = $('#branchID');
    const selectedBranchText = branchSelect.find('option:selected').text().trim();
    
    // Create new row with empty inputs
    const newRow = `
      <tr class="transfer-tr">
        <td><input class="form-control branch-name" value="${selectedBranchText}" disabled></td>
        <td>
          <select class="form-control company-name">
            <option value="">اختر الشركة</option>
            <option value="اقودا">اقودا</option>
            <option value="اكسبيديا">اكسبيديا</option>
            <option value="TRIP">TRIP</option>
            <option value="بوكينق">بوكينق</option>
            <option value="اخرى">اخرى</option>
            <option value="المطار">المطار</option>
            <option value="المسافر">المسافر</option>
            <option value="اخرى 1">اخرى 1</option>
            <option value="اخرى 2">اخرى 2</option>
          </select>
        </td>
        <td><input class="form-control reservation-ref" value=""></td>
        <td><input type="text" class="form-control reservation-date" value="" disabled></td>
        <td><input type="number" class="form-control reservation-amount" value=""></td>
        <td><input type="number" class="form-control sent-amount" value=""></td>
        <td><input type="number" class="form-control transferred-amount" value=""></td>
        <td><input type="number" class="form-control commission-voucher" value="" disabled></td>
        <td><input type="number" class="form-control bank-fees" value="" disabled></td>
        <td><input class="form-control voucher-number" value=""></td>
        <td>
          <select class="form-control received-select" disabled>
            <option value="لا" selected>لا</option>
            <option value="نعم">نعم</option>
          </select>
        </td>
        <td><input class="form-control notes" value=""></td>
      </tr>
    `;
    
    tbody.append(newRow);
    
    // Enable received dropdown only for AccountantManager
    const userRole = $('[data-user-role]').attr('data-user-role');
    const newRowReceived = tbody.find('tr:last .received-select');
    if (userRole === 'AccountantManager') {
      newRowReceived.prop('disabled', false);
    }
    
    // Add change event listener to update background color for received dropdown
    updateReceivedDropdowns();
    
    // Calculate initial values for the new row (will be calculated automatically when values are entered)
  });

  // Function to update received dropdown styling
  function updateReceivedDropdowns() {
    $('.received-select').off('change').on('change', function() {
      $(this).removeClass('received-yes received-no');
      if ($(this).val() === 'نعم') {
        $(this).addClass('received-yes');
      } else if ($(this).val() === 'لا') {
        $(this).addClass('received-no');
      }
    });
    
    // Set initial colors for existing dropdowns
    $('.received-select').each(function() {
      if ($(this).val() === 'نعم') {
        $(this).addClass('received-yes');
      } else if ($(this).val() === 'لا') {
        $(this).addClass('received-no');
      }
    });
  }

  // Initialize on page load
  $(document).ready(function() {
    updateReceivedDropdowns();
    initializeAutoDateFill();
    initializeAutoCalculations();
  });

  // Function to auto-calculate commission voucher and bank fees
  function initializeAutoCalculations() {
    // Function to calculate values for a specific row
    function calculateRowValues(row) {
      const reservationAmount = parseFloat(row.find('.reservation-amount').val()) || 0;
      const sentAmount = parseFloat(row.find('.sent-amount').val()) || 0;
      const transferredAmount = parseFloat(row.find('.transferred-amount').val()) || 0;
      
      // العمولة سند صرف = مبلغ الحجز - المبلغ المحول في القروب
      const commissionVoucher = reservationAmount - transferredAmount;
      row.find('.commission-voucher').val(commissionVoucher.toFixed(2));
      
      // رسوم البنك = المبلغ المرسل في الموقع - المبلغ المحول في القروب
      const bankFees = sentAmount - transferredAmount;
      row.find('.bank-fees').val(bankFees.toFixed(2));
    }
    
    // Handle changes to reservation amount, sent amount, or transferred amount
    $(document).on('input change', '.reservation-amount, .sent-amount, .transferred-amount', function() {
      const row = $(this).closest('tr');
      calculateRowValues(row);
    });
    
    // Calculate initial values for existing rows
    $('.transfer-tr').each(function() {
      calculateRowValues($(this));
    });
  }

  // Function to auto-fill reservation date when both company and reservation ref are present
  function initializeAutoDateFill() {
    // Function to check and fill date for a specific row
    function checkAndFillDate(row) {
      const companySelect = row.find('.company-name');
      const reservationRef = row.find('.reservation-ref');
      const reservationDate = row.find('.reservation-date');
      
      const companyValue = companySelect.val();
      const refValue = reservationRef.val().trim();
      
      // Only fill if both are present
      if (companyValue && refValue) {
        // Get today's date and current time in HH:mm:ss mm/dd/yyyy format (time before date)
        const today = new Date();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const year = today.getFullYear();
        const hours = String(today.getHours()).padStart(2, '0');
        const minutes = String(today.getMinutes()).padStart(2, '0');
        const seconds = String(today.getSeconds()).padStart(2, '0');
        const formattedDate = `${hours}:${minutes}:${seconds} ${month}/${day}/${year}`;
        
        reservationDate.val(formattedDate);
      }
    }
    
    // Handle company dropdown change
    $(document).on('change', '.company-name', function() {
      const row = $(this).closest('tr');
      checkAndFillDate(row);
    });
    
    // Handle reservation ref input blur (when user leaves the field)
    $(document).on('blur', '.reservation-ref', function() {
      const row = $(this).closest('tr');
      checkAndFillDate(row);
    });
    
    // Handle reservation ref input enter key
    $(document).on('keypress', '.reservation-ref', function(e) {
      if (e.which === 13) { // Enter key
        e.preventDefault();
        const row = $(this).closest('tr');
        checkAndFillDate(row);
        $(this).blur(); // Remove focus
      }
    });
  }
</script>

